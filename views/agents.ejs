<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Equipo - Cygnus</title>
    
    <link rel="stylesheet" href="/css/styles.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- LAYOUT GENERAL --- */
        .agents-container {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        /* --- BADGES DE ROL --- */
        .badge {
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }
        .badge-admin { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .badge-corredor { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }

        /* --- TABLA --- */
        .table-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; text-align: left; padding: 1rem; color: #64748b; font-weight: 600; }
        td { padding: 1rem; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        
        /* --- BOTONES DE ACCIÓN --- */
        .btn-action {
            width: 35px; height: 35px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
        }
        .btn-view { background: #e0e7ff; color: #4338ca; } /* Botón Ver Perfil */
        .btn-view:hover { background: #c7d2fe; color: #312e81; }

        .btn-edit { background: #f3f4f6; color: #4b5563; }
        .btn-edit:hover { background: #e5e7eb; color: #111827; }

        .btn-delete { background: #fee2e2; color: #ef4444; }
        .btn-delete:hover { background: #fecaca; color: #b91c1c; }

        .btn-primary {
            background: #2563eb; color: white;
            padding: 0.75rem 1.5rem; border-radius: 8px;
            border: none; cursor: pointer; font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
            transition: transform 0.2s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary:hover { transform: translateY(-2px); }

        /* --- MODALES Y ANIMACIONES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal-content {
            background: white;
            width: 90%; max-width: 480px;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            transform: translateY(20px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-overlay.active .modal-content { transform: translateY(0) scale(1); }

        /* --- INPUTS PERSONALIZADOS (Phone & Password) --- */
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #475569; font-size: 0.9rem; font-weight: 500; }
        
        /* Input simple */
        .input-control {
            width: 100%; padding: 0.75rem;
            border: 1px solid #cbd5e1; border-radius: 8px;
            font-size: 1rem; transition: border 0.2s;
        }
        .input-control:focus { border-color: #2563eb; outline: none; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        /* Grupo para Teléfono (+56 fijo) */
        .input-group-phone {
            display: flex;
            align-items: center;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            overflow: hidden;
        }
        .input-group-phone span {
            background: #f1f5f9;
            color: #64748b;
            padding: 0.75rem 1rem;
            font-weight: 600;
            border-right: 1px solid #cbd5e1;
        }
        .input-group-phone input {
            border: none;
            padding: 0.75rem;
            width: 100%;
            outline: none;
        }

        /* Grupo para Password (con ojo) */
        .input-group-pass {
            position: relative;
        }
        .input-group-pass input {
            width: 100%;
            padding-right: 40px; /* Espacio para el icono */
        }
        .toggle-pass-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 1rem;
        }
        .toggle-pass-btn:hover { color: #2563eb; }

        .modal-footer { margin-top: 2rem; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-cancel {
            background: transparent; color: #64748b; border: 1px solid #cbd5e1;
            padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;
        }
        .btn-cancel:hover { background: #f1f5f9; }
    </style>
</head>
<body>

    <div class="agents-container">
        
        <div class="page-header">
            <div>
                <h1 style="margin:0; font-size: 1.8rem; color: #0f172a;">Equipo Inmobiliario</h1>
                <p style="color: #64748b; margin-top: 5px;">
                    Gestiona los accesos y roles de tu fuerza de ventas.
                </p>
            </div>
            <button onclick="openModal('create')" class="btn-primary">
                <i class="fas fa-user-plus"></i> Nuevo Agente
            </button>
        </div>

        <div class="table-card">
            <table>
                <thead>
                    <tr>
                        <th>Agente</th>
                        <th>Contacto</th>
                        <th>Rol Asignado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (users && users.length > 0) { %>
                        <% users.forEach(agente => { %>
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 38px; height: 38px; background: #e0f2fe; color: #0369a1; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                        <%= agente.name.charAt(0) %>
                                    </div>
                                    <span style="font-weight: 500; color: #334155;"><%= agente.name %></span>
                                </div>
                            </td>
                            <td>
                                <div style="font-weight: 500;"><%= agente.email %></div>
                                <div style="font-size: 0.85rem; color: #64748b; margin-top:2px;">
                                    <i class="fab fa-whatsapp" style="color: #22c55e;"></i> 
                                    <%= agente.phone ? '+56 ' + agente.phone : 'Sin teléfono' %>
                                </div>
                            </td>
                            <td>
                                <span class="badge <%= agente.role === 'admin' ? 'badge-admin' : 'badge-corredor' %>">
                                    <%= agente.role === 'admin' ? 'Administrador' : 'Corredor' %>
                                </span>
                            </td>
                            <td>
                                <a href="/admin/agents/profile/<%= agente._id %>" class="btn-action btn-view" title="Ver Perfil">
                                    <i class="fas fa-eye"></i>
                                </a>

                                <button class="btn-action btn-edit" 
                                        title="Editar / Cambiar Contraseña"
                                        onclick="openModal('edit', {
                                            id: '<%= agente._id %>',
                                            name: '<%= agente.name %>',
                                            email: '<%= agente.email %>',
                                            phone: '<%= agente.phone %>',
                                            role: '<%= agente.role %>' 
                                        })">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>

                                <% if (user._id.toString() !== agente._id.toString()) { %>
                                    <button class="btn-action btn-delete" title="Eliminar" onclick="confirmDelete('<%= agente._id %>')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                <% } %>
                            </td>
                        </tr>
                        <% }) %>
                    <% } else { %>
                        <tr><td colspan="4" style="text-align: center; padding: 2rem; color: #94a3b8;">No hay agentes registrados.</td></tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <div id="agentModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin-top: 0; margin-bottom: 1.5rem; color: #1e293b;">Datos del Agente</h2>
            
            <form id="agentForm" action="/admin/agents/create" method="POST">
                <input type="hidden" name="agentId" id="inpId">

                <div class="form-group">
                    <label>Nombre Completo</label>
                    <input type="text" name="name" id="inpName" class="input-control" required placeholder="Ej. Matías Mora">
                </div>
                
                <div class="form-group">
                    <label>Correo Electrónico</label>
                    <input type="email" name="email" id="inpEmail" class="input-control" required placeholder="correo@cygnus.cl">
                </div>

                <div class="form-group">
                    <label>Teléfono (Móvil)</label>
                    <div class="input-group-phone">
                        <span>+56</span>
                        <input type="tel" name="phone" id="inpPhone" placeholder="9 1234 5678" maxlength="11">
                    </div>
                </div>

                <div class="form-group">
                    <label>Rol de Usuario</label>
                    <select name="role" id="inpRole" class="input-control" required>
                        <option value="corredor">Corredor Inmobiliario</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Contraseña</label>
                    <div class="input-group-pass">
                        <input type="password" name="password" id="inpPassword" class="input-control" placeholder="••••••">
                        <button type="button" class="toggle-pass-btn" onclick="togglePasswordVisibility()">
                            <i class="fas fa-eye" id="passIcon"></i>
                        </button>
                    </div>
                    <small id="passHint" style="display:none; color: #64748b; margin-top: 5px; font-size: 0.8rem;">
                        <i class="fas fa-info-circle"></i> Déjalo vacío para mantener la contraseña actual.
                    </small>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeModal('agentModal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div id="deleteModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 style="margin: 0; color: #1e293b;">¿Desvincular Agente?</h2>
            <p style="color: #64748b; margin: 1rem 0;">
                El usuario perderá el acceso al sistema inmediatamente. Sus propiedades serán reasignadas a administración.
            </p>
            <form id="deleteForm" method="POST">
                <div class="modal-footer" style="justify-content: center;">
                    <button type="button" class="btn-cancel" onclick="closeModal('deleteModal')">Cancelar</button>
                    <button type="submit" class="btn-primary" style="background: #ef4444; border:none;">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Referencias
        const agentModal = document.getElementById('agentModal');
        const deleteModal = document.getElementById('deleteModal');
        const agentForm = document.getElementById('agentForm');
        const passHint = document.getElementById('passHint');
        const inpPhone = document.getElementById('inpPhone');
        
        // --- LÓGICA DE FORMATO DE TELÉFONO (9 XXXX XXXX) ---
        inpPhone.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, ''); // Solo números
            
            // Limitar a 9 caracteres (formato chileno móvil estándar)
            if (value.length > 9) value = value.slice(0, 9);
            
            // Añadir espacios visuales: 9 1234 5678
            if (value.length > 5) {
                value = value.replace(/(\d{1})(\d{4})(\d+)/, '$1 $2 $3');
            } else if (value.length > 1) {
                value = value.replace(/(\d{1})(\d+)/, '$1 $2');
            }
            
            e.target.value = value;
        });

        // --- LÓGICA DE VISIBILIDAD DE CONTRASEÑA ---
        function togglePasswordVisibility() {
            const passInput = document.getElementById('inpPassword');
            const passIcon = document.getElementById('passIcon');
            
            if (passInput.type === "password") {
                passInput.type = "text";
                passIcon.classList.remove('fa-eye');
                passIcon.classList.add('fa-eye-slash');
            } else {
                passInput.type = "password";
                passIcon.classList.remove('fa-eye-slash');
                passIcon.classList.add('fa-eye');
            }
        }

        // --- ABRIR MODAL (Crear / Editar) ---
        function openModal(type, data = null) {
            agentForm.reset();
            // Resetear icono de contraseña a cerrado
            document.getElementById('inpPassword').type = "password";
            document.getElementById('passIcon').className = "fas fa-eye";

            if (type === 'create') {
                document.getElementById('modalTitle').innerText = 'Nuevo Agente';
                agentForm.action = '/admin/agents/create';
                document.getElementById('inpId').value = '';
                passHint.style.display = 'none';
                
                // Resetear Select al default
                document.getElementById('inpRole').value = 'corredor';

            } else if (type === 'edit' && data) {
                document.getElementById('modalTitle').innerText = 'Editar Agente';
                agentForm.action = '/admin/agents/edit';
                
                // Rellenar datos
                document.getElementById('inpId').value = data.id;
                document.getElementById('inpName').value = data.name;
                document.getElementById('inpEmail').value = data.email;
                
                // Formatear teléfono al cargar en el input
                let ph = data.phone || '';
                // Simular el evento input para formatearlo visualmente si ya tiene datos
                if(ph) {
                    ph = ph.toString().replace(/\D/g, '');
                    if (ph.length > 5) ph = ph.replace(/(\d{1})(\d{4})(\d+)/, '$1 $2 $3');
                    else if (ph.length > 1) ph = ph.replace(/(\d{1})(\d+)/, '$1 $2');
                }
                document.getElementById('inpPhone').value = ph;

                // Seleccionar el rol correcto
                // Asegúrate que en tu DB los roles sean 'admin' o 'corredor' (o 'agent')
                // Aquí ajusto el select al valor que viene de la DB
                document.getElementById('inpRole').value = (data.role === 'admin') ? 'admin' : 'corredor';

                passHint.style.display = 'block'; 
            }
            agentModal.classList.add('active');
        }

        function confirmDelete(id) {
            const deleteForm = document.getElementById('deleteForm');
            deleteForm.action = `/admin/agents/delete/${id}`;
            deleteModal.classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>