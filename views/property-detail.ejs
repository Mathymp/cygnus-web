<!DOCTYPE html>
<html lang="es">
<head>
    <%- include('partials/head') %>
    <title><%= prop.title %> | Cygnus Group</title>
    <link rel="stylesheet" href="/css/property-detail.css">
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@900,700,500,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* =========================================
           CYGNUS DETAIL ‚Äì DEFINITIVO (ESPACIO REDUCIDO + REF OCULTA M√ìVIL)
           ========================================= */
        
        /* ----- GRID PRINCIPAL: SIN ESPACIO BAJO CARRUSEL ----- */
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1.1fr;
            gap: 40px;
            align-items: start;
            margin-top: 20px;
        }

        /* ----- GALER√çA: MARGEN INFERIOR REDUCIDO (menos espacio) ----- */
        .gallery-container {
            margin-bottom: 20px;  /* antes 30px */
        }

        /* ----- FEATURES WIDGET ‚Äì COMPACTADO M√ÅXIMO ----- */
        .features-widget {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid var(--c-border);
            margin-top: 16px;
            margin-bottom: 0;
        }

        .fw-header {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--c-border);
        }

        .fw-title {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--c-dark);
            margin: 0;
        }

        .fw-group {
            margin-bottom: 16px;
        }
        .fw-group:last-child {
            margin-bottom: 0;
        }

        .fw-cat-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #94a3b8;
            font-weight: 700;
            margin: 0 0 8px 0;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .fw-cat-title i {
            color: var(--c-primary);
            opacity: 0.7;
            font-size: 0.75rem;
        }

        .fw-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .fw-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: #475569;
            line-height: 1.2;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 5px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .fw-item:hover {
            background-color: white;
            border-color: #cbd5e1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            transform: translateY(-1px);
        }

        .fw-item i {
            color: #10b981;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .fw-item span {
            font-weight: 600;
        }

        /* ----- SUPERFICIE (junto a caracter√≠sticas) ----- */
        .surface-mini-card {
            background: white;
            border: 1px solid var(--c-border);
            border-radius: 16px;
            padding: 16px 20px;
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .surface-mini-item {
            display: flex;
            flex-direction: column;
        }

        .surface-mini-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: #94a3b8;
            font-weight: 700;
            letter-spacing: 0.3px;
        }

        .surface-mini-value {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--c-dark);
            line-height: 1.2;
        }

        .surface-mini-unit {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
            margin-left: 2px;
        }

        /* ----- RESPONSIVE: m√≥vil 1 columna + FIX OVERLAY + OCULTAR REF ----- */
        @media (max-width: 900px) {
            .content-grid {
                grid-template-columns: 1fr;
                gap: 30px;
            }
            .main-stage {
                height: auto;
            }
            .main-stage img {
                height: auto;
                object-fit: scale-down;
            }
            .sticky-widget {
                position: static !important;
                top: auto;
            }
            .thumb-scroll-wrapper {
                padding: 0 30px;
            }
            .features-widget {
                margin-top: 30px;
            }
            .fw-list {
                grid-template-columns: 1fr;
            }
            .surface-mini-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            /* üîß OCULTAR REFERENCIA EN M√ìVIL (no tapa otros elementos) */
            .ref-pill {
                display: none !important;
            }

            /* üîß FIX: overlay de estado en m√≥vil ‚Äì abajo izquierda */
            .img-overlay-left,
            .img-overlay-right {
                z-index: 60 !important;
            }
            .status-overlay-center {
                align-items: flex-end;
                justify-content: flex-start;
                height: auto;
                top: auto;
                bottom: 20px;
                left: 20px;
                right: auto;
                width: auto;
                background: transparent;
                z-index: 50;
            }
            .status-glass-card {
                transform: rotate(0deg);
                font-size: 1.2rem;
                padding: 8px 20px;
                backdrop-filter: blur(8px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            }
        }

        @media (max-width: 400px) {
            .fw-list {
                grid-template-columns: 1fr;
            }
        }

        /* ----- RESTO DE ESTILOS (sin cambios) ----- */
        :root {
            --c-dark: #0f172a;
            --c-primary: #2563eb; 
            --c-gray-bg: #f8fafc;
            --c-border: #e2e8f0;
            --c-text: #334155;
            --font: 'Satoshi', sans-serif;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: var(--c-gray-bg);
            color: var(--c-text);
            font-family: var(--font);
            margin: 0;
            overflow-x: hidden;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .col-left, .col-right {
            min-width: 0;
        }

        .prop-header { margin-bottom: 20px; }

        .prop-title {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--c-dark);
            line-height: 1.1;
            margin: 0 0 10px 0;
            letter-spacing: -1px;
        }

        .address-inline {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #475569;
            font-size: 1.05rem;
            flex-wrap: wrap;
        }

        .map-icon { color: var(--c-primary); font-size: 1.2rem; }

        .addr-tag {
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 4px;
            letter-spacing: 0.5px;
        }
        .addr-tag.exact { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .addr-tag.approx { background-color: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }

        .addr-text { font-weight: 500; color: #334155; }

        .main-stage {
            position: relative;
            width: 100%;
            height: 450px;
            background: #cbd5e1;
            border-radius: 16px;
            overflow: hidden;
            cursor: zoom-in;
            box-shadow: var(--shadow);
        }
        .main-stage img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: 0.3s; 
        }

        .img-overlay-left {
            position: absolute; top: 20px; left: 20px;
            display: flex; gap: 8px; z-index: 10;
        }
        .badge {
            padding: 6px 14px; border-radius: 50px;
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
            color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }
        .op-badge.sale { background: var(--c-primary); }
        .op-badge.rent { background: #f97316; }
        .cat-badge { background: white; color: var(--c-dark); }

        .img-overlay-right {
            position: absolute; top: 20px; right: 20px; z-index: 10;
        }
        .ref-pill {
            background: rgba(0,0,0,0.5);
            color: rgba(255,255,255,0.95);
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 600;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.2);
            letter-spacing: 0.5px;
        }

        .nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: white; border: none; width: 44px; height: 44px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); opacity: 0; transition: 0.2s;
            color: var(--c-dark); font-size: 1.1rem; z-index: 5;
        }
        .main-stage:hover .nav-btn { opacity: 1; }
        .prev { left: 20px; } .next { right: 20px; }

        .photo-badge {
            position: absolute; bottom: 20px; right: 20px;
            background: rgba(15, 23, 42, 0.75); color: white;
            padding: 6px 14px; border-radius: 20px; font-size: 0.8rem;
            backdrop-filter: blur(4px); font-weight: 600; z-index: 5;
        }

        .thumb-scroll-wrapper {
            margin-top: 15px;
            position: relative;
            padding: 0 40px;
        }

        .thumb-track {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: none;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        .thumb-track::-webkit-scrollbar { display: none; }

        .thumb {
            flex: 0 0 120px;
            height: 80px;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            background: #e2e8f0;
        }
        .thumb img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
        .thumb:hover { transform: translateY(-2px); border-color: #cbd5e1; }
        .thumb.active { border-color: var(--c-primary); transform: translateY(0); box-shadow: 0 0 0 2px rgba(37,99,235,0.2); }

        .thumb-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 32px; height: 32px; border-radius: 50%;
            background: white; border: 1px solid #cbd5e1;
            color: #334155; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        .thumb-nav:hover { background: #2563eb; color: white; border-color: #2563eb; }
        .thumb-nav.left { left: 0; }
        .thumb-nav.right { right: 0; }

        .specs-section {
            background: #ffffff;
            border: 1px solid var(--c-border);
            border-radius: 16px;
            padding: 25px 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            margin-bottom: 30px;
        }

        .specs-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            color: #94a3b8;
            font-weight: 700;
            margin: 0 0 15px 0;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .specs-title i { color: var(--c-primary); font-size: 0.9rem; }

        .specs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 15px;
            align-items: stretch;
        }

        .spec-card {
            background: #f8fafc;
            border: 1px solid var(--c-border);
            border-radius: 10px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: transform 0.2s;
        }
        .spec-card:hover {
            border-color: #cbd5e1;
            background: #f1f5f9;
        }
        .spec-card.wide { grid-column: span 2; }

        .spec-icon {
            font-size: 1.2rem;
            color: var(--c-primary);
            margin-bottom: 6px;
            opacity: 0.9;
        }

        .spec-label {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .spec-value {
            font-size: 1rem;
            color: var(--c-dark);
            font-weight: 800;
            line-height: 1.2;
        }

        .h-line-soft { height: 1px; background: var(--c-border); margin: 20px 0; opacity: 0.6; }
        .h-line { height: 1px; background: var(--c-border); margin: 35px 0; }

        .info-section h3 { font-size: 1.4rem; color: var(--c-dark); margin-bottom: 20px; font-weight: 800; }
        .desc-text { line-height: 1.75; font-size: 1.05rem; color: #475569; }

        .map-frame {
            height: 350px; background: #e2e8f0; border-radius: 16px;
            overflow: hidden; position: relative; border: 1px solid var(--c-border);
        }
        #google-map { width: 100%; height: 100%; }
        .map-warning {
            position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
            background: white; padding: 8px 20px; border-radius: 30px; font-size: 0.85rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 600; color: #64748b;
        }

        .sticky-widget {
            background: white;
            padding: 30px;
            padding-top: 50px !important;
            border-radius: 24px;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
            border: 1px solid var(--c-border);
            position: sticky;
            top: 20px;
            position: relative !important;
        }

        .uf-corner-badge {
            position: absolute; top: 25px; right: 25px;
            font-size: 0.65rem; color: #94a3b8; font-weight: 700;
            background: transparent; padding: 0; z-index: 100;
            letter-spacing: 0.5px; border: none;
            display: flex; align-items: center; gap: 4px;
        }
        .uf-corner-badge i { font-size: 0.6rem; color: #cbd5e1; }

        .status-pill-widget {
            position: absolute; top: 25px; left: 25px;
            font-size: 0.65rem; font-weight: 800; padding: 4px 10px;
            border-radius: 6px; text-transform: uppercase; z-index: 100;
            letter-spacing: 0.5px; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-overlay-center {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            z-index: 40; pointer-events: none; background: transparent;
        }

        .status-glass-card {
            transform: rotate(-6deg);
            padding: 12px 35px;
            border-radius: 8px;
            color: white;
            font-size: 1.8rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .glass-sold { background: rgb(255, 0, 0); }
        .glass-rented { background: #0044ffed; }
        .glass-reserved { background: rgba(255, 176, 5, 0.945); }
        .glass-inactive { background: rgba(71, 85, 105, 0.60); }

        .bg-sold { background: #ff0000; color: white; }
        .bg-rented { background: #0044ff; color: white; }
        .bg-reserved { background: #ff9d09; color: white; }
        .bg-inactive { background: #475569; color: white; }
        .bg-available { background: #d1fae5; color: #059669; border: 1px solid #a7f3d0; box-shadow: none; }

        .price-header { text-align: center; margin-bottom: 25px; margin-top: 5px; }
        .lbl-op { font-size: 0.8rem; text-transform: uppercase; color: #94a3b8; font-weight: 700; letter-spacing: 1px; }

        .price-main {
            font-size: 2.8rem; font-weight: 900;
            color: var(--c-primary); line-height: 1;
            letter-spacing: -1.5px; margin: 10px 0 10px 0;
        }
        .price-main .period { font-size: 1.2rem; color: #64748b; font-weight: 500; }

        .price-pill-container { display: flex; justify-content: center; }
        .price-pill-small {
            background: #f1f5f9; color: #475569;
            padding: 4px 12px; border-radius: 6px;
            font-size: 0.9rem; font-weight: 600; display: inline-block;
        }

        .extra-costs {
            background: #f8fafc; padding: 18px; border-radius: 12px;
            border: 1px solid var(--c-border); margin-bottom: 25px;
        }
        .cost-item { display: flex; justify-content: space-between; font-size: 0.95rem; margin-bottom: 8px; color: #64748b; }
        .cost-item strong { color: var(--c-dark); }
        .cost-item:last-child { margin-bottom: 0; }

        .agent-row { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; }

        .agent-img-wrap {
            width: 60px; height: 60px;
            border-radius: 50%; overflow: hidden;
            border: 1px solid var(--c-border);
            background: white;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .agent-img-wrap img {
            width: 100%; height: 100%; object-fit: contain; padding: 4px;
        }

        .agent-txt { display: flex; flex-direction: column; justify-content: center; }
        .tiny-lbl { font-size: 0.65rem; text-transform: uppercase; color: #94a3b8; font-weight: 700; letter-spacing: 0.5px; }
        .agent-row h4 { margin: 2px 0 0 0; color: var(--c-dark); font-size: 1.1rem; font-weight: 700; }
        .agent-sub { font-size: 0.8rem; color: #64748b; display: block; margin-top: 2px; }
        .agent-role-small {
            font-size: 0.7rem;
            color: #94a3b8;
            font-weight: 600;
            display: block;
            margin-top: 1px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-btns { display: flex; flex-direction: column; gap: 10px; }
        .btn {
            border: none; padding: 12px; border-radius: 12px;
            font-weight: 700; cursor: pointer; text-decoration: none;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            transition: 0.2s; font-size: 1rem;
        }

        .btn-whatsapp { background: #25D366; color: white; box-shadow: 0 4px 10px rgba(37,211,102,0.2); }
        .btn-whatsapp:hover { background: #20bd5a; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(37,211,102,0.3); }

        .btn-call { background: var(--c-dark); color: white; box-shadow: 0 4px 10px rgba(15,23,42,0.2); }
        .btn-call:hover { background: #1e293b; transform: translateY(-2px); }

        .btn-email { background: white; border: 2px solid var(--c-border); color: var(--c-text); }
        .btn-email:hover { border-color: var(--c-dark); color: var(--c-dark); background: #f8fafc; }

        .main-stage { overflow: hidden; cursor: zoom-in; position: relative; }
        .main-stage img { transition: transform 0.2s ease-out, opacity 0.2s; transform-origin: center center; will-change: transform, transform-origin; }
        .main-stage.zoomed img { transform: scale(1.8); cursor: zoom-out; }
        .main-stage.zoomed .img-overlay-left, 
        .main-stage.zoomed .img-overlay-right, 
        .main-stage.zoomed .photo-badge, 
        .main-stage.zoomed .nav-btn {
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }

        .desc-text sup { vertical-align: super; font-size: smaller; }
        .desc-text sub { vertical-align: sub; font-size: smaller; }
        .desc-text sup, .desc-text sub { line-height: 0; position: relative; vertical-align: baseline; }
        .desc-text sup { top: -0.5em; }
        .desc-text sub { bottom: -0.25em; }

        @media (max-width: 768px) {
            .price-main { font-size: 2.2rem; }
            .address-inline { flex-direction: column; align-items: flex-start; gap: 5px; }
            .spec-card.wide { grid-column: span 1; }
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
            margin: 4px 0;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }
        ::-webkit-scrollbar-thumb:active {
            background-color: #64748b;
        }
    </style>
</head>
<body class="bg-slate-50">

    <%- include('partials/navbar') %>

    <% 
        // --- PROCESAMIENTO DE IM√ÅGENES ---
        let images = [];
        try {
            if (typeof prop.images === 'string') images = JSON.parse(prop.images);
            else if (Array.isArray(prop.images)) images = prop.images;
        } catch(e) {}
        if(!images || images.length === 0) images = [{url: '/img/logo.png'}];
        images = images.map(img => img.url ? img.url : img);

        // --- PROCESAMIENTO DE PRECIOS E INDICADORES ---
        const fmtCLP = (valor) => '$ ' + Number(valor).toLocaleString('es-CL', { maximumFractionDigits: 0 });
        const fmtUF = (valor) => 'UF ' + Number(valor).toLocaleString('es-CL', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        
        let ufVal = 39000;
        if (typeof indicators !== 'undefined' && indicators.uf) ufVal = indicators.uf;
        else if (typeof ufValue !== 'undefined') ufVal = ufValue;
        
        let price = parseFloat(prop.price) || 0;
        let currency = prop.currency || 'UF';
        let isRent = (prop.operation_type && prop.operation_type.toLowerCase().includes('arriendo'));
        let rentSuffix = isRent ? '<span class="period">/mes</span>' : '';

        let mainPriceDisplay, subPriceDisplay;
        if (currency === 'UF') {
            mainPriceDisplay = fmtUF(price);
            subPriceDisplay = fmtCLP(price * ufVal);
        } else {
            mainPriceDisplay = fmtCLP(price);
            subPriceDisplay = fmtUF(price / ufVal);
        }

        // --- L√ìGICA DE ESTADO ---
        let statusRaw = (prop.status || prop.state || 'disponible').toLowerCase().trim();
        const activeKeywords = ['disponible', 'publicada', 'publicado', 'activa', 'activo', 'en venta', 'en arriendo'];
        let isAvailable = activeKeywords.some(s => statusRaw.includes(s));
        if (statusRaw.includes('vend') || statusRaw.includes('arrendad') || statusRaw.includes('reserv') || statusRaw.includes('borrador')) {
            isAvailable = false;
        }

        let statusConfig = { 
            text: 'DISPONIBLE', 
            glassClass: '', 
            solidClass: 'bg-available',
            showOverlay: false
        };

        if (!isAvailable) {
            statusConfig.showOverlay = true;
            if (statusRaw.includes('vend')) {
                statusConfig.text = 'VENDIDA';
                statusConfig.glassClass = 'glass-sold';
                statusConfig.solidClass = 'bg-sold';
            } else if (statusRaw.includes('arrend')) {
                statusConfig.text = 'ARRENDADA';
                statusConfig.glassClass = 'glass-rented';
                statusConfig.solidClass = 'bg-rented';
            } else if (statusRaw.includes('reserv')) {
                statusConfig.text = 'RESERVADA';
                statusConfig.glassClass = 'glass-reserved';
                statusConfig.solidClass = 'bg-reserved';
            } else {
                statusConfig.text = 'NO DISPONIBLE';
                statusConfig.glassClass = 'glass-inactive';
                statusConfig.solidClass = 'bg-inactive';
            }
        }
        
        // --- L√ìGICA DE CARACTER√çSTICAS ---
        let featureGroups = {};
        let hasFeatures = false;
        try {
            if (prop.features && typeof prop.features === 'object') {
                Object.entries(prop.features).forEach(([groupKey, groupData]) => {
                    if (typeof groupData === 'object' && groupData !== null) {
                        let activeItems = [];
                        Object.entries(groupData).forEach(([key, val]) => {
                            if (val === true || val === 'on' || val === 1) {
                                let label = key.replace(/_/g, ' ');
                                label = label.charAt(0).toUpperCase() + label.slice(1);
                                activeItems.push(label);
                            }
                        });
                        if (activeItems.length > 0) {
                            let title = groupKey.replace(/_/g, ' ').replace(/features/i, '').trim();
                            if(title.toLowerCase().includes('indoor') || title.toLowerCase().includes('interior')) title = 'Interiores';
                            else if(title.toLowerCase().includes('outdoor') || title.toLowerCase().includes('exterior')) title = 'Exteriores';
                            else if(title.toLowerCase().includes('security') || title.toLowerCase().includes('seguridad')) title = 'Seguridad';
                            else if(title.toLowerCase().includes('general')) title = 'General';
                            else title = title.charAt(0).toUpperCase() + title.slice(1);
                            featureGroups[title] = activeItems;
                            hasFeatures = true;
                        }
                    }
                });
            }
        } catch(e) {}

        const joinAddr = (...parts) => parts.filter(p => p && p.toString().trim().length > 0).join(', ');
        const hasSurface = (prop.surface_util > 0 || prop.surface_total > 0);
        const hasDistrib = (prop.bedrooms > 0 || prop.bathrooms > 0 || prop.parking > 0 || prop.storage_units > 0);
        const hasDetails = (prop.condition || prop.orientation || (prop.property_age && prop.property_age > 0));
        const showSpecsSection = (hasDistrib || hasDetails);

        // --- L√ìGICA AGENTE ---
        const cleanTitle = prop.title.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '').trim();
        
        let contactInfo = {
            displayName: 'Cygnus Group Propiedades',
            role: 'Corredor de Propiedades',
            photo: '/img/logo.png',
            phone: '+56923830830',
            email: 'contacto@cygnusgroup.cl',
            wspNumber: '56923830830'
        };

        if (prop.agent && prop.agent.name) {
            let phoneClean = prop.agent.phone ? prop.agent.phone.replace(/\D/g,'') : '56923830830';
            contactInfo.displayName = prop.agent.name;
            contactInfo.subtitle = 'Cygnus Group Propiedades';
            contactInfo.role = 'Corredor Inmobiliario';
            contactInfo.phone = prop.agent.phone || '+56923830830';
            contactInfo.email = prop.agent.email || 'contacto@cygnusgroup.cl';
            contactInfo.wspNumber = phoneClean;
        }
    %>

    <div class="main-container">
        <div class="content-grid">
            <!-- COLUMNA IZQUIERDA - Parte 1: Header y Galer√≠a -->
            <div class="col-left">
                <header class="prop-header">
                    <h1 class="prop-title"><%= prop.title %></h1>
                    <div class="address-inline">
                        <i class="fas fa-map-marker-alt map-icon"></i>
                        <% if(prop.show_exact_address) { %>
                            <span class="addr-tag exact">Exacta</span>
                            <span class="addr-text">
                                <%= prop.address_street %> #<%= prop.address_number %>, 
                                <%= joinAddr(prop.address_commune, prop.city, prop.address_region || prop.region) %>
                            </span>
                        <% } else { %>
                            <span class="addr-tag approx">Referencial</span>
                            <span class="addr-text">
                                <%= joinAddr(prop.address_street, prop.address_commune, prop.city, prop.address_region || prop.region) %>
                            </span>
                        <% } %>
                    </div>
                </header>

                <!-- GALER√çA DE FOTOS -->
                <div class="gallery-container">
                    <div class="main-stage" id="mainStage" onclick="toggleZoom(event)">
                        
                        <% if(statusConfig.showOverlay) { %>
                            <div class="status-overlay-center">
                                <div class="status-glass-card <%= statusConfig.glassClass %>">
                                    <%= statusConfig.text %>
                                </div>
                            </div>
                        <% } %>

                        <div class="img-overlay-left">
                            <span class="badge op-badge <%= isRent ? 'rent' : 'sale' %>">
                                <%= prop.operation_type || 'Venta' %>
                            </span>
                            <span class="badge cat-badge">
                                <%= prop.category || 'Propiedad' %>
                            </span>
                        </div>
                        <div class="img-overlay-right">
                            <span class="ref-pill">REF: <%= prop.id %></span>
                        </div>
                        <img id="stageImg" src="<%= images[0] %>" alt="Foto Principal">
                        <button class="nav-btn prev" onclick="event.stopPropagation(); moveSlide(-1)"><i class="fas fa-chevron-left"></i></button>
                        <button class="nav-btn next" onclick="event.stopPropagation(); moveSlide(1)"><i class="fas fa-chevron-right"></i></button>
                        <div class="photo-badge">
                            <i class="fas fa-camera"></i> <span id="photoCount">1 / <%= images.length %></span>
                        </div>
                    </div>
                    <div class="thumb-scroll-wrapper">
                        <button class="thumb-nav left" onclick="scrollThumbs('left')"><i class="fas fa-chevron-left"></i></button>
                        <div class="thumb-track" id="thumbTrack">
                            <% images.forEach((img, i) => { %>
                                <div class="thumb <%= i===0?'active':'' %>" onclick="setSlide(<%= i %>)">
                                    <img src="<%= img %>" loading="lazy">
                                </div>
                            <% }) %>
                        </div>
                        <button class="thumb-nav right" onclick="scrollThumbs('right')"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div> <!-- /.col-left (parte 1) -->

            <!-- COLUMNA DERECHA (Tarjeta de precio + caracter√≠sticas + superficie) -->
            <div class="col-right">
                <div class="sticky-widget">
                    
                    <div class="status-pill-widget <%= statusConfig.solidClass %>">
                        <%= statusConfig.text %>
                    </div>

                    <div class="uf-corner-badge" title="Valor UF Actualizado">
                        UF <%= fmtCLP(ufVal).replace('$ ', '$') %>
                    </div>
                    
                    <div class="price-header">
                        <span class="lbl-op">Valor de <%= prop.operation_type || 'Venta' %></span>
                        <div class="price-main"><%= mainPriceDisplay %> <%- rentSuffix %></div>
                        <div class="price-pill-container">
                            <span class="price-pill-small">Aprox. <%= subPriceDisplay %></span>
                        </div>
                    </div>

                    <% if(prop.common_expenses > 0 || prop.contributions > 0) { %>
                    <div class="extra-costs">
                        <% if(prop.common_expenses > 0) { %>
                            <div class="cost-item"><span>Gastos Comunes</span> <strong><%= fmtCLP(prop.common_expenses) %></strong></div>
                        <% } %>
                        <% if(prop.contributions > 0) { %>
                            <div class="cost-item"><span>Contribuciones</span> <strong><%= fmtCLP(prop.contributions) %></strong></div>
                        <% } %>
                    </div>
                    <% } %>
                    
                    <div class="h-line-soft"></div>
                    
                    <div class="agent-row">
                        <div class="agent-img-wrap"><img src="<%= contactInfo.photo %>" alt="Empresa"></div>
                        <div class="agent-txt">
                            <span class="tiny-lbl">Publicado por</span>
                            <h4><%= contactInfo.displayName %></h4>
                            <span class="agent-sub"><%= contactInfo.subtitle %></span>
                            <span class="agent-role-small"><%= contactInfo.role %></span>
                        </div>
                    </div>
                    
                    <div class="action-btns">
                        <a href="#" id="btnWsp" target="_blank" class="btn btn-whatsapp">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </a>
                        <a href="tel:<%= contactInfo.phone %>" class="btn btn-call"><i class="fas fa-phone-alt"></i> Llamar</a>
                        <a href="mailto:<%= contactInfo.email %>?subject=Consulta propiedad <%= cleanTitle %>&body=Hola, estoy interesado en la propiedad..." class="btn btn-email"><i class="far fa-envelope"></i> Enviar Correo</a>
                    </div>
                </div>

                <!-- CARACTER√çSTICAS (COMPACTAS) -->
                <% if(hasFeatures) { %>
                    <div class="features-widget">
                        <div class="fw-header">
                            <h3 class="fw-title">Caracter√≠sticas</h3>
                        </div>
                        <% Object.keys(featureGroups).forEach(groupTitle => { %>
                            <div class="fw-group">
                                <h4 class="fw-cat-title"><i class="fas fa-layer-group"></i> <%= groupTitle %></h4>
                                <ul class="fw-list">
                                    <% featureGroups[groupTitle].forEach(item => { %>
                                        <li class="fw-item">
                                            <i class="fas fa-circle-check"></i>
                                            <span><%= item %></span>
                                        </li>
                                    <% }) %>
                                </ul>
                            </div>
                        <% }) %>
                    </div>
                <% } %>

                <!-- SUPERFICIE (INTEGRADA JUSTO DEBAJO) -->
                <% if(hasSurface) { %>
                <div class="surface-mini-card">
                    <% if(prop.surface_util > 0) { %>
                    <div class="surface-mini-item">
                        <span class="surface-mini-label">√ötil</span>
                        <span class="surface-mini-value"><%= prop.surface_util %> <span class="surface-mini-unit">m¬≤</span></span>
                    </div>
                    <% } %>
                    <% if(prop.surface_total > 0) { %>
                    <div class="surface-mini-item">
                        <span class="surface-mini-label">Total</span>
                        <span class="surface-mini-value"><%= prop.surface_total %> <span class="surface-mini-unit">m¬≤</span></span>
                    </div>
                    <% } %>
                    <% if(prop.surface_terrace > 0) { %>
                    <div class="surface-mini-item">
                        <span class="surface-mini-label">Terraza</span>
                        <span class="surface-mini-value"><%= prop.surface_terrace %> <span class="surface-mini-unit">m¬≤</span></span>
                    </div>
                    <% } %>
                </div>
                <% } %>

            </div> <!-- /.col-right -->

            <!-- COLUMNA IZQUIERDA - Parte 2: Distribuci√≥n, Detalles, Descripci√≥n, Mapa -->
            <div class="col-left">
                <% if(showSpecsSection) { %>
                <div class="specs-section compact">
                    <% if(hasDistrib) { %>
                    <div class="specs-row">
                        <h4 class="specs-title">Distribuci√≥n</h4>
                        <div class="specs-grid">
                            <div class="spec-card">
                                <i class="fas fa-bed spec-icon"></i>
                                <div class="spec-data">
                                    <strong class="spec-value"><%= prop.bedrooms || 0 %></strong>
                                    <span class="spec-label">Dorms</span>
                                </div>
                            </div>
                            <div class="spec-card">
                                <i class="fas fa-bath spec-icon"></i>
                                <div class="spec-data">
                                    <strong class="spec-value"><%= prop.bathrooms || 0 %></strong>
                                    <span class="spec-label">Ba√±os</span>
                                </div>
                            </div>
                            <% if(prop.parking > 0) { %>
                            <div class="spec-card">
                                <i class="fas fa-car spec-icon"></i>
                                <div class="spec-data">
                                    <strong class="spec-value"><%= prop.parking %></strong>
                                    <span class="spec-label">Estac.</span>
                                </div>
                            </div>
                            <% } %>
                            <% if(prop.storage_units > 0) { %>
                            <div class="spec-card">
                                <i class="fas fa-box spec-icon"></i>
                                <div class="spec-data">
                                    <strong class="spec-value"><%= prop.storage_units %></strong>
                                    <span class="spec-label">Bodegas</span>
                                </div>
                            </div>
                            <% } %>
                        </div>
                    </div>
                    <% } %>

                    <% if(hasDistrib && hasDetails) { %> <div style="height: 1px; background: #e2e8f0; margin: 20px 0; opacity: 0.6;"></div> <% } %>

                    <% if(hasDetails) { %>
                    <div class="specs-row">
                        <h4 class="specs-title">Detalles</h4>
                        <div class="specs-grid">
                            <% if(prop.condition) { %>
                            <div class="spec-card wide">
                                <div class="spec-data">
                                    <strong class="spec-value"><%= prop.condition %></strong>
                                    <span class="spec-label">Estado</span>
                                </div>
                            </div>
                            <% } %>
                            <% if(prop.orientation) { %>
                            <div class="spec-card wide">
                                <div class="spec-data">
                                    <strong class="spec-value"><%= prop.orientation %></strong>
                                    <span class="spec-label">Orientaci√≥n</span>
                                </div>
                            </div>
                            <% } %>
                            <% if(prop.property_age > 0) { %>
                            <div class="spec-card">
                                <div class="spec-data">
                                    <strong class="spec-value"><%= prop.property_age %> A√±os</strong>
                                    <span class="spec-label">Antig√ºedad</span>
                                </div>
                            </div>
                            <% } %>
                        </div>
                    </div>
                    <% } %>
                </div>
                <% } %>
                
                <div class="specs-section">
                    <h3 style="font-size: 1.4rem; color: #0f172a; margin-bottom: 20px; font-weight: 800;">Descripci√≥n</h3>
                    <div class="desc-text">
                        <%- prop.description %>
                    </div>
                </div>

                <section class="info-section">
                    <h3 style="font-size: 1.4rem; color: #0f172a; margin-bottom: 20px; font-weight: 800;">Ubicaci√≥n</h3>
                    <div class="map-frame">
                        <div id="google-map"></div>
                        <% if(!prop.show_exact_address) { %>
                            <div class="map-warning"><i class="fas fa-info-circle"></i> Ubicaci√≥n aproximada</div>
                        <% } %>
                    </div>
                </section>
            </div> <!-- /.col-left (parte 2) -->

        </div> <!-- /.content-grid -->
    </div> <!-- /.main-container -->

    <%- include('partials/footer') %>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBeMVmY5lCw_TvvUBr6uZh8VrVlWHrU7lg&callback=initMap" async defer></script>
    <script>
        // --- WHATSAPP DYNAMIC LINK ---
        document.addEventListener('DOMContentLoaded', () => {
            const currentUrl = window.location.href;
            const titleClean = "<%= cleanTitle %>";
            const ref = "<%= prop.id %>";
            const wspNum = "<%= contactInfo.wspNumber %>";
            const text = `Hola, vi la propiedad ${titleClean} en: ${currentUrl}`;
            const link = `https://wa.me/${wspNum}?text=${encodeURIComponent(text)}`;
            
            document.getElementById('btnWsp').href = link;
        });

        // --- GALER√çA LOGIC ---
        const images = <%- JSON.stringify(images) %>;
        let currentIdx = 0;
        const stageImg = document.getElementById('stageImg');
        const count = document.getElementById('photoCount');
        const thumbs = document.querySelectorAll('.thumb');
        const thumbTrack = document.getElementById('thumbTrack');
        const mainStage = document.getElementById('mainStage');

        function toggleZoom(e) {
            if(e.target.closest('.nav-btn')) return;
            mainStage.classList.toggle('zoomed');
            if(mainStage.classList.contains('zoomed')) moveMagnifier(e);
            else setTimeout(() => { stageImg.style.transformOrigin = 'center center'; }, 250);
        }
        function moveMagnifier(e) {
            if(!mainStage.classList.contains('zoomed')) return;
            const rect = mainStage.getBoundingClientRect();
            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;
            let xPercent = Math.max(0, Math.min(100, (x / rect.width) * 100));
            let yPercent = Math.max(0, Math.min(100, (y / rect.height) * 100));
            stageImg.style.transformOrigin = `${xPercent}% ${yPercent}%`;
        }
        mainStage.addEventListener('mousemove', moveMagnifier);
        mainStage.addEventListener('mouseleave', () => { if(mainStage.classList.contains('zoomed')) toggleZoom({target: mainStage}); });

        function scrollThumbs(dir) {
            const amount = 150;
            thumbTrack.scrollBy({ left: dir === 'left' ? -amount : amount, behavior: 'smooth' });
        }
        function setSlide(idx) {
            if(mainStage.classList.contains('zoomed')) toggleZoom({target: mainStage});
            currentIdx = idx;
            stageImg.style.opacity = 0.5;
            setTimeout(() => { stageImg.src = images[currentIdx]; stageImg.style.opacity = 1; }, 150);
            count.innerText = `${currentIdx + 1} / ${images.length}`;
            thumbs.forEach(t => t.classList.remove('active'));
            if(thumbs[currentIdx]) {
                thumbs[currentIdx].classList.add('active');
                thumbs[currentIdx].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }
        function moveSlide(dir) {
            let next = currentIdx + dir;
            if(next >= images.length) next = 0;
            if(next < 0) next = images.length - 1;
            setSlide(next);
        }
        document.addEventListener('keydown', e => {
            if(e.key === 'ArrowRight') moveSlide(1);
            if(e.key === 'ArrowLeft') moveSlide(-1);
            if(e.key === 'Escape' && mainStage.classList.contains('zoomed')) toggleZoom({target: mainStage});
        });

        function initMap() {
            const lat = <%= prop.latitude || -33.44889 %>;
            const lng = <%= prop.longitude || -70.669265 %>;
            const isExact = <%= prop.show_exact_address ? 'true' : 'false' %>;
            const map = new google.maps.Map(document.getElementById("google-map"), { zoom: 15, center: {lat, lng}, disableDefaultUI: false, mapTypeId: 'roadmap' });
            if(isExact) new google.maps.Marker({position:{lat,lng}, map});
            else new google.maps.Circle({ strokeColor: "#2563eb", fillColor: "#2563eb", fillOpacity: 0.15, map, center: {lat,lng}, radius: 300 });
        }
    </script>
</body>
</html>