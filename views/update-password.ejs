<!DOCTYPE html>
<html lang="es">
<head>
    <%- include('./partials/head') %>
    <link rel="stylesheet" href="/css/login.css">
    <title>Nueva Contraseña | Cygnus</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <div class="bg-architect"></div>
    <div class="bg-overlay"></div>

    <main class="login-container">
        <div class="glass-card">
            
            <div class="login-header">
                <div id="loadingUser">
                    <div class="loader" style="display:inline-block; border-color: #2563eb; border-top-color: transparent;"></div>
                    <p style="margin-top:10px;">Verificando enlace...</p>
                </div>

                <div id="userInfo" class="hidden">
                    <div class="logo-circle" style="width: 60px; height: 60px; margin-bottom: 20px;">
                        <img src="/img/logo.png" alt="Cygnus" class="logo-img">
                    </div>
                    <h1 id="greetingTitle">Hola</h1>
                    <p>Crea una nueva contraseña segura para tu cuenta.</p>
                </div>
            </div>

            <div class="alert-box">
                <%- include('./partials/alerts') %>
                <div id="jsError" style="display:none; background:#fee2e2; color:#ef4444; padding:10px; border-radius:8px; font-size:0.9rem;"></div>
            </div>

            <form action="/update-password" method="POST" id="updateForm" class="hidden">
                <input type="hidden" name="accessToken" id="accessToken">

                <div class="input-group">
                    <label>Nueva Contraseña</label>
                    <div class="input-wrapper">
                        <i class="ph-fill ph-lock-key"></i>
                        <input type="password" id="passwordInput" name="password" placeholder="Mínimo 6 caracteres" required minlength="6">
                        <button type="button" class="btn-toggle-pass" id="togglePass">
                            <i class="ph-fill ph-eye"></i>
                        </button>
                    </div>
                </div>

                <button type="submit" class="btn-primary">
                    Confirmar Cambio
                </button>
            </form>

        </div>
    </main>

    <script>
        // CONFIGURACIÓN RECIBIDA DEL SERVER
        const supabaseUrl = '<%= supabaseUrl %>';
        const supabaseKey = '<%= supabaseKey %>';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        document.addEventListener("DOMContentLoaded", async () => {
            const loadingDiv = document.getElementById('loadingUser');
            const infoDiv = document.getElementById('userInfo');
            const form = document.getElementById('updateForm');
            const title = document.getElementById('greetingTitle');
            const errorDiv = document.getElementById('jsError');

            // 1. OBTENER TOKEN DE LA URL (Hash fragment)
            // El link del correo viene como: /update-password#access_token=xyz&...
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');
            const type = params.get('type'); // debería ser 'recovery'

            if (!accessToken) {
                loadingDiv.style.display = 'none';
                errorDiv.innerText = "Enlace inválido o incompleto. Solicita uno nuevo.";
                errorDiv.style.display = 'block';
                return;
            }

            // 2. LLENAR EL CAMPO OCULTO
            document.getElementById('accessToken').value = accessToken;

            try {
                // 3. PREGUNTAR A SUPABASE: ¿QUIÉN ES ESTE USUARIO?
                const { data: { user }, error } = await supabaseClient.auth.getUser(accessToken);

                if (error || !user) throw new Error("Token expirado");

                // 4. OBTENER EL NOMBRE DESDE LA TABLA 'USERS'
                const { data: profile } = await supabaseClient
                    .from('users')
                    .select('name')
                    .eq('id', user.id)
                    .single();

                // 5. MOSTRAR INTERFAZ PERSONALIZADA
                if (profile && profile.name) {
                    // Tomamos el primer nombre para ser amigables
                    const firstName = profile.name.split(' ')[0]; 
                    title.innerText = `Hola, ${firstName}`;
                }

                // Limpiar la URL para que no se vea el código feo
                window.history.replaceState(null, null, window.location.pathname);

                // Mostrar todo
                loadingDiv.style.display = 'none';
                infoDiv.classList.remove('hidden');
                infoDiv.classList.add('fade-in'); // Animación CSS si la tienes
                form.classList.remove('hidden');

            } catch (err) {
                console.error(err);
                loadingDiv.style.display = 'none';
                errorDiv.innerText = "Este enlace ha expirado. Por favor solicita uno nuevo en el Login.";
                errorDiv.style.display = 'block';
            }
        });

        // Toggle Password
        const toggleBtn = document.getElementById('togglePass');
        const passInput = document.getElementById('passwordInput');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => {
                const isPass = passInput.type === 'password';
                passInput.type = isPass ? 'text' : 'password';
                toggleBtn.querySelector('i').className = isPass ? 'ph-fill ph-eye-slash' : 'ph-fill ph-eye';
            });
        }
    </script>

    <style>
        .hidden { display: none; }
        .loader {
            width: 30px; height: 30px; 
            border: 3px solid #e2e8f0; border-radius: 50%; 
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        /* Animación suave de entrada */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</body>
</html>