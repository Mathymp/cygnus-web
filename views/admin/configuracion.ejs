<!DOCTYPE html>
<html lang="es">
<head>
    <%- include('../partials/head') %>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="/css/publish.css">
    <link rel="stylesheet" href="/css/configuracion.css">
</head>
<body>
    <div class="app-layout">
        <%- include('../partials/sidebar-admin') %>

        <main class="main-content">
            <div class="publish-wrapper-fluid">
        
                <form id="configForm" onsubmit="event.preventDefault();">
                    
                    <div class="header-actions-bar">
                        <div class="header-title">
                            <h1><i class="fas fa-sliders-h"></i> Editor Visual</h1>
                            <span class="uf-badge">Modo Dise√±o</span>
                        </div>
                        <div class="actions-group">
                             <button type="button" class="btn-primary-glow" onclick="saveConfiguration()">
                                Guardar Cambios <i class="fas fa-save"></i>
                            </button>
                        </div>
                    </div>

                    <div class="publish-grid config-grid-layout">
                        
                        <div class="col-main">
                            
                            <div class="panel-card animated-entry">
                                <div class="panel-header-flex">
                                    <h3 class="panel-title"><i class="fas fa-hard-hat"></i> Modo Mantenci√≥n</h3>
                                    <label class="privacy-switch">
                                        <input type="checkbox" name="maintenance_active" id="maintSwitch" <%= config.maintenance_active ? 'checked' : '' %>>
                                        <span class="slider-round"></span>
                                        <span class="switch-text">Activar Bloqueo</span>
                                     </label>
                                </div>
                                <div class="form-group">
                                    <label>Mensaje para el cliente</label>
                                    <div id="maintQuill" class="quill-modern-small">
                                        <%- config.maintenance_message || '<h1 class="ql-align-center">Sitio en Mantenci√≥n</h1><p class="ql-align-center">Volvemos pronto.</p>' %>
                                    </div>
                                </div>
                            </div>

                            <div class="panel-card animated-entry" style="animation-delay: 0.1s; overflow: visible !important;">
                                <div class="panel-header-flex">
                                    <h3 class="panel-title"><i class="fas fa-bullhorn"></i> Barra Superior</h3>
                                    <label class="privacy-switch">
                                        <input type="checkbox" name="announcement_active" id="annSwitch" <%= config.announcement_active ? 'checked' : '' %>>
                                        <span class="slider-round"></span>
                                        <span class="switch-text">Mostrar</span>
                                     </label>
                                </div>

                                <div class="grid-2-sm mb-3">
                                    <div class="form-group">
                                        <label>Color Fondo</label>
                                        <div class="color-picker-wrapper">
                                            <div class="color-preview" id="previewAnnBg" style="background-color: <%= config.announcement_bg || '#1e293b' %>;"></div>
                                            <input type="color" name="announcement_bg" id="annBg" value="<%= config.announcement_bg || '#1e293b' %>">
                                            <span class="color-label"><%= config.announcement_bg || '#1e293b' %></span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Color Texto</label>
                                        <div class="color-picker-wrapper">
                                            <div class="color-preview" id="previewAnnColor" style="background-color: <%= config.announcement_color || '#ffffff' %>;"></div>
                                            <input type="color" name="announcement_color" id="annColor" value="<%= config.announcement_color || '#ffffff' %>">
                                            <span class="color-label"><%= config.announcement_color || '#ffffff' %></span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group" style="position:relative;">
                                    <div class="editor-toolbar-extra">
                                        <label>Contenido del Anuncio</label>
                                        <div class="emoji-dropdown-wrapper">
                                            <button type="button" class="btn-ghost-sm" onclick="toggleEmojiMenu(event)">üòä Emojis</button>
                                            <div class="emoji-menu" id="emojiMenu">
                                                <span onclick="addEmoji('üî•')">üî•</span><span onclick="addEmoji('üè°')">üè°</span>
                                                <span onclick="addEmoji('‚ö°')">‚ö°</span><span onclick="addEmoji('‚≠ê')">‚≠ê</span>
                                                <span onclick="addEmoji('üéâ')">üéâ</span><span onclick="addEmoji('üìç')">üìç</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="annQuill" class="quill-modern-small">
                                        <%- config.announcement_text || '¬°Cont√°ctanos hoy mismo!' %>
                                    </div>
                                </div>
                            </div>

                            <div class="panel-card animated-entry" style="animation-delay: 0.2s;">
                                <div class="panel-header-flex">
                                    <h3 class="panel-title"><i class="fas fa-images"></i> Slider Principal</h3>
                                    <div class="range-wrapper">
                                        <span class="text-muted text-sm">Velocidad: <b id="speedText"><%= config.slider_speed || 5 %>s</b></span>
                                        <input type="range" name="slider_speed" id="sliderSpeed" min="2" max="10" value="<%= config.slider_speed || 5 %>" class="range-modern">
                                    </div>
                                </div>

                                <div class="upload-zone-wide" id="uploadZone">
                                    <div class="upload-content">
                                        <i class="fas fa-cloud-upload-alt icon-upload"></i>
                                        <div style="text-align:center;">
                                            <strong style="display:block; font-size:1.1rem; margin-bottom:5px;">Agregar Fotos Nuevas</strong>
                                            <p class="text-sm text-muted">Arrastra o haz click aqu√≠</p>
                                        </div>
                                    </div>
                                    <input type="file" id="fileInput" multiple accept="image/*" style="display:none;">
                                </div>

                                <div class="section-divider">
                                    <span>Orden y Edici√≥n</span>
                                </div>

                                <div class="gallery-wide-grid" id="bannersContainer">
                                    <% if(config.banners && config.banners.length > 0) { %>
                                        <% config.banners.forEach((b) => { %>
                                            <div class="img-card-wide banner-item existing-banner" 
                                                 data-type="existing"
                                                 data-url="<%= b.url %>" 
                                                 data-align="<%= b.align || '50% 50%' %>">
                                                
                                                <img src="<%= b.url %>" style="object-position: <%= b.align || '50% 50%' %>;">
                                                
                                                <div class="badge-cover">
                                                    <i class="fas fa-check-circle"></i> Publicado
                                                </div>
                                                
                                                <div class="banner-actions">
                                                    <button type="button" class="btn-mini focus" onclick="openFocusModal(this)" title="Ajustar Foco">
                                                        <i class="fas fa-crosshairs"></i>
                                                    </button>
                                                    <button type="button" class="btn-mini delete" onclick="removeBanner(this)" title="Eliminar">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        <% }) %>
                                    <% } %>
                                </div>
                                <p class="text-muted text-sm mt-2"><i class="fas fa-info-circle"></i> Arrastra las im√°genes para reordenar el slider.</p>
                            </div>

                        </div> 

                        <div class="col-side sticky-preview-col">
                            <div class="device-shell">
                                <div class="device-header">
                                    <div class="dots"><span></span><span></span><span></span></div>
                                    <div class="device-title">Vista Previa en Vivo</div>
                                    <div class="device-controls">
                                        <button type="button" class="device-icon active" onclick="setDevice('desktop')" title="Escritorio"><i class="fas fa-desktop"></i></button>
                                        <button type="button" class="device-icon" onclick="setDevice('mobile')" title="M√≥vil"><i class="fas fa-mobile-alt"></i></button>
                                    </div>
                                </div>
                                
                                <div class="device-screen-container">
                                    <div id="iframeWrapper" class="iframe-wrapper desktop">
                                        <iframe id="liveFrame" src="/"></iframe>
                                    </div>
                                </div>
                            </div>
                            <div class="preview-note">
                                <i class="fas fa-sync-alt"></i> Los cambios se reflejan autom√°ticamente.
                            </div>
                        </div>

                    </div> 
                </form>
                <div style="height: 100px;"></div>
            </div>
        </main>
    </div>

    <div id="focusModal" class="modal-overlay">
        <div class="modal-box swal-modern focus-box">
            <div class="modal-top">
                <h3><i class="fas fa-crosshairs"></i> Ajustar Foco de Imagen</h3>
                <button type="button" class="btn-close" onclick="closeFocusModal()">&times;</button>
            </div>
            <div class="modal-content-focus">
                <p class="focus-instruction">Haz click en la parte m√°s importante de la foto.</p>
                
                <div class="focus-canvas-container">
                    <div class="focus-wrap" id="focusWrap">
                        <img id="focusImg" src="" draggable="false">
                        <div id="focusTarget">
                            <div class="crosshair-v"></div>
                            <div class="crosshair-h"></div>
                        </div>
                    </div>
                </div>
                
                <div class="focus-coords">
                    Posici√≥n: <span id="coordsDisplay">50% 50%</span>
                </div>
            </div>
            <div class="modal-actions-right">
                <button type="button" class="btn-ghost" onclick="closeFocusModal()">Cancelar</button>
                <button type="button" class="btn-primary-glow" onclick="applyFocus()">Aplicar Foco</button>
            </div>
        </div>
    </div>

    <script>
        // --- GESTI√ìN DE ESTADO ---
        let qMaint, qAnn;
        let bannerUploads = []; // Almacena objetos { id, file, url } para los NUEVOS archivos
        let currentEditingElement = null; // Elemento DOM que se est√° editando (foco)
        let focusX = 50, focusY = 50;

        document.addEventListener('DOMContentLoaded', () => {
            initEditors();
            initListeners();
            initSortable();
            // Iniciar ajuste de vista previa
            setTimeout(updateLivePreview, 1500); // Esperar a que cargue el iframe
        });

        // 1. INICIALIZACI√ìN DE EDITORES QUILL
        function initEditors() {
            qMaint = new Quill('#maintQuill', { theme: 'snow', modules: { toolbar: [['bold', 'italic', 'header'], [{ 'color': [] }, { 'align': [] }]] } });
            qAnn = new Quill('#annQuill', { theme: 'snow', modules: { toolbar: false } });

            // Eventos de cambio para actualizar preview
            qMaint.on('text-change', () => updateLivePreview());
            qAnn.on('text-change', () => updateLivePreview());
        }

        // 2. LISTENERS GENERALES
        function initListeners() {
            // Inputs de Color
            document.getElementById('annBg').addEventListener('input', (e) => {
                document.getElementById('previewAnnBg').style.backgroundColor = e.target.value;
                document.querySelector('.color-label', e.target.parentElement).innerText = e.target.value;
                updateLivePreview();
            });
            document.getElementById('annColor').addEventListener('input', (e) => {
                document.getElementById('previewAnnColor').style.backgroundColor = e.target.value;
                updateLivePreview();
            });

            // Switches
            document.getElementById('maintSwitch').addEventListener('change', updateLivePreview);
            document.getElementById('annSwitch').addEventListener('change', updateLivePreview);
            
            // Slider Speed
            document.getElementById('sliderSpeed').addEventListener('input', (e) => {
                document.getElementById('speedText').innerText = e.target.value + 's';
                updateLivePreview();
            });

            // Carga de Archivos
            const upZone = document.getElementById('uploadZone');
            const fInput = document.getElementById('fileInput');
            
            upZone.onclick = () => fInput.click();
            
            fInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    const uid = Math.random().toString(36).substr(2, 9);
                    const blobUrl = URL.createObjectURL(file);
                    
                    // Guardamos referencia en memoria para el POST
                    bannerUploads.push({ id: uid, file: file, url: blobUrl });
                    
                    // Creamos tarjeta visual
                    createBannerCard(uid, blobUrl, '50% 50%', true);
                });
                fInput.value = ''; // Reset
                updateLivePreview();
            });

            // Re-inyectar al cargar el iframe
            document.getElementById('liveFrame').onload = () => {
                setTimeout(updateLivePreview, 500);
            };

            // Ajuste responsivo del iframe
            window.addEventListener('resize', fitPreview);
            setTimeout(fitPreview, 1000);
        }

        // 3. SORTABLE (Arrastrar y Soltar)
        function initSortable() {
            new Sortable(document.getElementById('bannersContainer'), {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: () => {
                    updateLivePreview(); // Actualizar orden en preview
                }
            });
        }

        // --- CREACI√ìN VISUAL DE TARJETAS ---
        function createBannerCard(uid, url, align, isNew) {
            const container = document.getElementById('bannersContainer');
            const div = document.createElement('div');
            div.className = `img-card-wide banner-item ${isNew ? 'new-banner' : 'existing-banner'}`;
            
            // Atributos de datos
            div.dataset.type = isNew ? 'new' : 'existing';
            div.dataset.id = uid; // Para nuevos usamos ID, para viejos usamos URL como ID impl√≠cito
            div.dataset.url = url;
            div.dataset.align = align;

            div.innerHTML = `
                <img src="${url}" style="object-position: ${align};">
                <div class="badge-cover" style="background: ${isNew ? '#10b981' : '#3b82f6'}">
                    <i class="fas ${isNew ? 'fa-plus' : 'fa-check'}"></i> ${isNew ? 'Nuevo' : 'Publicado'}
                </div>
                <div class="banner-actions">
                    <button type="button" class="btn-mini focus" onclick="openFocusModal(this)"><i class="fas fa-crosshairs"></i></button>
                    <button type="button" class="btn-mini delete" onclick="removeBanner(this)"><i class="fas fa-trash"></i></button>
                </div>
            `;
            container.appendChild(div);
        }

        // --- ELIMINAR BANNER ---
        window.removeBanner = (btn) => {
            const item = btn.closest('.banner-item');
            
            // Si es nuevo, borrar de memoria tambi√©n
            if (item.dataset.type === 'new') {
                const uid = item.dataset.id;
                const idx = bannerUploads.findIndex(x => x.id === uid);
                if (idx > -1) bannerUploads.splice(idx, 1);
            }
            
            item.remove();
            updateLivePreview();
        };

        // --- L√ìGICA DE FOCO (MODAL) ---
        window.openFocusModal = (btn) => {
            currentEditingElement = btn.closest('.banner-item');
            const src = currentEditingElement.dataset.url;
            const currentAlign = currentEditingElement.dataset.align || '50% 50%';

            // Parsear "50% 50%" a X e Y
            const parts = currentAlign.replace(/%/g, '').split(' ');
            focusX = parseFloat(parts[0]);
            focusY = parseFloat(parts[1]);

            document.getElementById('focusImg').src = src;
            document.getElementById('focusModal').classList.add('active');
            updateFocusUI();
        };

        const focusWrap = document.getElementById('focusWrap');
        
        // Manejo del arrastre en el cuadro de foco
        function handleFocusMove(e) {
            const r = focusWrap.getBoundingClientRect();
            let x = ((e.clientX - r.left) / r.width) * 100;
            let y = ((e.clientY - r.top) / r.height) * 100;
            
            focusX = Math.max(0, Math.min(100, x));
            focusY = Math.max(0, Math.min(100, y));
            updateFocusUI();
        }

        focusWrap.onmousedown = (e) => {
            handleFocusMove(e);
            focusWrap.onmousemove = handleFocusMove;
        };
        
        window.addEventListener('mouseup', () => {
            focusWrap.onmousemove = null;
        });

        function updateFocusUI() {
            const target = document.getElementById('focusTarget');
            target.style.left = focusX + '%';
            target.style.top = focusY + '%';
            document.getElementById('coordsDisplay').innerText = `${Math.round(focusX)}% ${Math.round(focusY)}%`;
        }

        window.applyFocus = () => {
            const val = `${Math.round(focusX)}% ${Math.round(focusY)}%`;
            
            // Guardar en el DOM del admin
            currentEditingElement.dataset.align = val;
            currentEditingElement.querySelector('img').style.objectPosition = val;
            
            closeFocusModal();
            updateLivePreview();
        };

        window.closeFocusModal = () => document.getElementById('focusModal').classList.remove('active');

        // --- SISTEMA DE PREVISUALIZACI√ìN (CORE) ---
        function updateLivePreview() {
            const iframe = document.getElementById('liveFrame');
            const doc = iframe.contentDocument;
            if (!doc || !doc.body) return;

            // 1. Barra Superior
            const annActive = document.getElementById('annSwitch').checked;
            let annBar = doc.querySelector('.top-announcement-bar');
            
            // Si no existe, cr√©ala (o b√≥rrala si ya no se quiere y re-creala para limpiar)
            if (!annBar) {
                annBar = doc.createElement('div');
                annBar.className = 'top-announcement-bar';
                annBar.style.cssText = "width:100%; z-index:9000; position:relative; text-align:center; padding:10px; font-weight:bold; transition:all 0.3s;";
                doc.body.prepend(annBar);
            }

            annBar.style.display = annActive ? 'block' : 'none';
            annBar.style.backgroundColor = document.getElementById('annBg').value;
            annBar.style.color = document.getElementById('annColor').value;
            annBar.innerHTML = qAnn.root.innerHTML;

            // 2. Pantalla de Mantenci√≥n (Overlay)
            const maintActive = document.getElementById('maintSwitch').checked;
            let maintOverlay = doc.getElementById('previewMaintOverlay');
            
            if (maintActive) {
                if (!maintOverlay) {
                    maintOverlay = doc.createElement('div');
                    maintOverlay.id = 'previewMaintOverlay';
                    maintOverlay.style.cssText = "position:fixed; inset:0; background:white; z-index:999999; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px;";
                    doc.body.appendChild(maintOverlay);
                }
                maintOverlay.style.display = 'flex';
                maintOverlay.innerHTML = qMaint.root.innerHTML;
            } else {
                if (maintOverlay) maintOverlay.style.display = 'none';
            }

            // 3. SLIDER / SWIPER (La parte cr√≠tica)
            const swiperWrapper = doc.querySelector('.swiper-wrapper');
            if (swiperWrapper) {
                // Obtener todos los banners actuales del grid (en orden visual)
                const items = Array.from(document.querySelectorAll('.banner-item'));
                
                let slidesHTML = '';
                
                if (items.length === 0) {
                    slidesHTML = '<div class="swiper-slide" style="height:100%; display:flex; align-items:center; justify-content:center; background:#333; color:#fff;">Sin im√°genes</div>';
                } else {
                    items.forEach(item => {
                        const src = item.dataset.url;
                        const align = item.dataset.align;
                        
                        slidesHTML += `
                            <div class="swiper-slide">
                                <div class="hero-slide" style="background-image:url('${src}'); background-position:${align}; height: 100%; width: 100%; background-size: cover;"></div>
                            </div>
                        `;
                    });
                }

                swiperWrapper.innerHTML = slidesHTML;

                // FORZAR ACTUALIZACI√ìN DE SWIPER
                // Inyectamos un script peque√±o en el iframe para que busque la instancia de swiper y la actualice
                const updateScript = doc.createElement('script');
                updateScript.textContent = `
                    try {
                        const swiperEl = document.querySelector('.swiper');
                        if(swiperEl && swiperEl.swiper) {
                            swiperEl.swiper.update();
                            swiperEl.swiper.slideTo(0);
                            
                            // Actualizar velocidad si es necesario
                            if(swiperEl.swiper.params && swiperEl.swiper.params.autoplay) {
                                swiperEl.swiper.params.autoplay.delay = ${document.getElementById('sliderSpeed').value} * 1000;
                                swiperEl.swiper.autoplay.start();
                            }
                        }
                    } catch(e) { console.log('Swiper update error', e); }
                `;
                doc.body.appendChild(updateScript);
            }
        }

        // --- GUARDAR CONFIGURACI√ìN (SUBMIT) ---
        window.saveConfiguration = async () => {
            const formData = new FormData();

            // 1. Textos y Configuraci√≥n Base
            formData.append('maintenance_active', document.getElementById('maintSwitch').checked ? 'on' : 'off');
            formData.append('maintenance_message', qMaint.root.innerHTML);
            
            formData.append('announcement_active', document.getElementById('annSwitch').checked ? 'on' : 'off');
            formData.append('announcement_bg', document.getElementById('annBg').value);
            formData.append('announcement_color', document.getElementById('annColor').value);
            formData.append('announcement_text', qAnn.root.innerHTML);
            
            formData.append('slider_speed', document.getElementById('sliderSpeed').value);

            // 2. Banners (Respetando el orden visual)
            const items = document.querySelectorAll('.banner-item');
            
            items.forEach(item => {
                const align = item.dataset.align;
                
                if (item.dataset.type === 'existing') {
                    // Es viejo: enviamos URL y Alineaci√≥n
                    formData.append('existing_banners_urls[]', item.dataset.url);
                    formData.append('existing_banners_align[]', align);
                } else {
                    // Es nuevo: buscamos el archivo real en memoria usando el ID
                    const uid = item.dataset.id;
                    const uploadObj = bannerUploads.find(u => u.id === uid);
                    
                    if (uploadObj) {
                        // Importante: El nombre 'new_banners' debe coincidir con upload.array() en el backend
                        formData.append('new_banners', uploadObj.file); 
                        formData.append('new_banners_align[]', align);
                    }
                }
            });

            // 3. Feedback Visual
            Swal.fire({
                title: 'Guardando...',
                html: 'Subiendo im√°genes y actualizando el sitio.',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const response = await fetch('/admin/configuracion/update', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: '¬°Guardado!',
                        text: 'La configuraci√≥n se actualiz√≥ correctamente.',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    throw new Error('Error en la respuesta del servidor');
                }
            } catch (error) {
                console.error(error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo guardar la configuraci√≥n. Intenta nuevamente.'
                });
            }
        };

        // --- UTILIDADES ---
        function toggleEmojiMenu(e) { 
            e.stopPropagation();
            document.getElementById('emojiMenu').classList.toggle('active'); 
        }
        
        function addEmoji(char) { 
            const range = qAnn.getSelection(true);
            qAnn.insertText(range ? range.index : qAnn.getLength(), char);
            document.getElementById('emojiMenu').classList.remove('active');
            updateLivePreview();
        }

        function setDevice(mode) {
            const wrap = document.getElementById('iframeWrapper');
            const btns = document.querySelectorAll('.device-icon');
            
            btns.forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active'); // Bot√≥n clickeado
            
            wrap.className = `iframe-wrapper ${mode}`;
            setTimeout(fitPreview, 300);
        }

        function fitPreview() {
            const shell = document.querySelector('.device-screen-container');
            const wrap = document.getElementById('iframeWrapper');
            if (!shell || !wrap) return;

            // Dimensiones objetivo
            const targetW = wrap.classList.contains('mobile') ? 375 : 1366;
            const targetH = wrap.classList.contains('mobile') ? 812 : 768;

            // Escalar para ajustar al contenedor disponible
            const scale = Math.min(
                (shell.clientWidth - 20) / targetW, 
                (shell.clientHeight - 20) / targetH
            );

            wrap.style.transform = `scale(${Math.min(scale, 1)})`; // Nunca escalar m√°s de 1
        }
        
        // Cerrar men√∫s al clickear fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.emoji-dropdown-wrapper')) {
                document.getElementById('emojiMenu').classList.remove('active');
            }
        });
    </script>
</body>
</html>