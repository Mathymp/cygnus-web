<% 
/* SISTEMA DE ALERTAS (TOASTS) - BLINDADO CONTRA NULLS */
%>

<div id="cg-alert-wrapper">

    <% if (typeof success_msg != 'undefined' && success_msg && success_msg.length > 0) { %>
        <div class="cg-toast success">
            <div class="cg-toast-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <div class="cg-toast-content">
                <span class="cg-toast-title">¡Éxito!</span>
                <span class="cg-toast-msg"><%= success_msg %></span>
            </div>
            <button class="cg-toast-close" onclick="dismissToast(this)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    <% } %>

    <% if (typeof error_msg != 'undefined' && error_msg && error_msg.length > 0) { %>
        <div class="cg-toast error">
            <div class="cg-toast-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
            </div>
            <div class="cg-toast-content">
                <span class="cg-toast-title">Error</span>
                <span class="cg-toast-msg"><%= error_msg %></span>
            </div>
            <button class="cg-toast-close" onclick="dismissToast(this)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    <% } %>

    <% /* AQUI ESTABA EL ERROR: Agregado "&& error" para validar que no sea null */ %>
    <% if (typeof error != 'undefined' && error && error.length > 0) { %>
        <div class="cg-toast error">
            <div class="cg-toast-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
            </div>
            <div class="cg-toast-content">
                <span class="cg-toast-title">Atención</span>
                <span class="cg-toast-msg"><%= error %></span>
            </div>
            <button class="cg-toast-close" onclick="dismissToast(this)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    <% } %>

    <% /* Agregado "&& success" también por seguridad */ %>
    <% if (typeof success != 'undefined' && success && success.length > 0) { %>
        <div class="cg-toast success">
            <div class="cg-toast-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <div class="cg-toast-content">
                <span class="cg-toast-title">¡Hecho!</span>
                <span class="cg-toast-msg"><%= success %></span>
            </div>
            <button class="cg-toast-close" onclick="dismissToast(this)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    <% } %>

    <% if (typeof errors != 'undefined' && errors && errors.length > 0) { %>
        <% errors.forEach(function(err) { %>
            <div class="cg-toast error">
                <div class="cg-toast-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </div>
                <div class="cg-toast-content">
                    <span class="cg-toast-title">Corregir</span>
                    <span class="cg-toast-msg"><%= err.msg %></span>
                </div>
                <button class="cg-toast-close" onclick="dismissToast(this)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        <% }) %>
    <% } %>

</div>

<style>
    /* RESET ESPECÍFICO PARA TOASTS */
    #cg-alert-wrapper * { 
        box-sizing: border-box;
        font-family: 'Inter', sans-serif; 
    }

    #cg-alert-wrapper {
        position: fixed; 
        top: 20px;
        right: 20px; 
        z-index: 10000;
        display: flex; 
        flex-direction: column; 
        gap: 12px; 
        pointer-events: none;
    }

    .cg-toast {
        pointer-events: auto; 
        min-width: 300px;
        max-width: 400px;
        background: white; 
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        display: flex; 
        align-items: flex-start; 
        gap: 15px;
        border: 1px solid #e2e8f0;
        border-left: 5px solid #cbd5e1;
        animation: slideIn 0.3s ease-out; 
        position: relative;
    }

    .cg-toast.success { border-left-color: #10b981; }
    .cg-toast.error { border-left-color: #ef4444; }

    .cg-toast-icon {
        width: 24px;
        height: 24px; 
        flex-shrink: 0;
        margin-top: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .cg-toast-icon svg {
        width: 100%;
        height: 100%;
        display: block;
    }

    .cg-toast.success .cg-toast-icon { color: #10b981; }
    .cg-toast.error .cg-toast-icon { color: #ef4444; }

    .cg-toast-content { 
        flex: 1;
        display: flex; 
        flex-direction: column; 
        gap: 2px;
    }
    
    .cg-toast-title { 
        font-weight: 700;
        font-size: 0.95rem; 
        color: #0f172a; 
    }
    
    .cg-toast-msg { 
        font-size: 0.9rem;
        color: #64748b; 
        line-height: 1.4; 
    }

    .cg-toast-close {
        background: none;
        border: none; 
        padding: 0; 
        color: #94a3b8;
        cursor: pointer; 
        opacity: 0.6; 
        transition: 0.2s; 
        margin-top: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .cg-toast-close:hover { 
        opacity: 1;
        color: #0f172a;
    }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
        to { transform: translateX(20px); opacity: 0; }
    }
</style>

<script>
    function dismissToast(btn) {
        const t = btn.closest('.cg-toast');
        if (t) {
            t.style.animation = 'fadeOut 0.3s forwards';
            setTimeout(() => t.remove(), 300);
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            const toasts = document.querySelectorAll('.cg-toast');
            toasts.forEach(t => {
                t.style.animation = 'fadeOut 0.5s forwards';
                setTimeout(() => t.remove(), 500);
            });
        }, 5000);
    });
</script>